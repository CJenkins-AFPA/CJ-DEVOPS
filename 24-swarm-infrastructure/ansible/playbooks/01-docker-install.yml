---
################################################################################
# Playbook: 01-docker-install.yml
#
# Purpose: Installer et configurer Docker CE
#   - Docker repository officielle
#   - Docker CE latest
#   - Docker Compose
#   - Docker CLI plugins
#   - User permissions
#   - Service configuration
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/01-docker-install.yml
#
# Tags:
#   - docker
#   - docker-repo
#   - docker-install
#   - docker-compose
#   - docker-permissions
#   - docker-config
#
################################################################################

- name: "Install and Configure Docker CE"
  hosts: all
  gather_facts: yes
  
  vars:
    docker_repo_url: "https://download.docker.com/linux"
    docker_gpg_key_url: "{{ docker_repo_url }}/{{ ansible_distribution | lower }}/gpg"
    docker_version: "latest"
  
  tasks:
    - name: "Display Docker installation plan"
      debug:
        msg: |
          ====================================
          Docker Installation Plan
          ====================================
          Distribution: {{ ansible_distribution }}
          Release: {{ ansible_distribution_release }}
          Docker Version: {{ docker_version }}
          ====================================
      tags: [always]
    
    # ========================================================================
    # Docker Repository Setup
    # ========================================================================
    
    - name: "Docker-Repo | Remove old Docker versions"
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
      tags: [docker, docker-repo]
      ignore_errors: yes
    
    - name: "Docker-Repo | Add Docker GPG key"
      apt_key:
        url: "{{ docker_gpg_key_url }}"
        state: present
      tags: [docker, docker-repo]
      register: docker_gpg
      until: docker_gpg is succeeded
      retries: 3
    
    - name: "Docker-Repo | Add Docker repository"
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] {{ docker_repo_url }}/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      tags: [docker, docker-repo]
    
    - name: "Docker-Repo | Update apt cache after adding repo"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [docker, docker-repo]
    
    # ========================================================================
    # Docker Engine Installation
    # ========================================================================
    
    - name: "Docker-Install | Install Docker CE and related packages"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      tags: [docker, docker-install]
      register: docker_install
      until: docker_install is succeeded
      retries: 3
    
    # ========================================================================
    # Docker Compose Installation (standalone, if needed)
    # ========================================================================
    
    - name: "Docker-Compose | Check docker-compose version"
      shell: "docker-compose --version 2>/dev/null || echo 'not installed'"
      changed_when: false
      register: compose_version
      tags: [docker, docker-compose]
    
    - name: "Docker-Compose | Display version"
      debug:
        msg: "Docker Compose: {{ compose_version.stdout }}"
      tags: [docker, docker-compose]
    
    # ========================================================================
    # Docker Daemon Configuration
    # ========================================================================
    
    - name: "Docker-Config | Create /etc/docker directory"
      file:
        path: /etc/docker
        state: directory
        mode: "0755"
      tags: [docker, docker-config]
    
    - name: "Docker-Config | Create daemon.json configuration"
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "debug": false,
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2",
            "userland-proxy": false,
            "bridge": "none",
            "icc": true,
            "live-restore": true,
            "max-concurrent-downloads": 10,
            "max-concurrent-uploads": 5,
            "ip-forward": true,
            "ip-masq": true,
            "experimental": false,
            "metrics-addr": "127.0.0.1:9323"
          }
        mode: "0644"
      notify: Restart Docker
      tags: [docker, docker-config]
    
    # ========================================================================
    # Docker Service Management
    # ========================================================================
    
    - name: "Docker-Service | Enable Docker service"
      systemd:
        name: docker
        enabled: yes
        state: started
      tags: [docker]
    
    - name: "Docker-Service | Ensure Docker is running"
      service:
        name: docker
        state: started
      tags: [docker]
    
    - name: "Docker-Service | Wait for Docker to be ready"
      shell: "docker ps"
      register: docker_status
      until: docker_status is succeeded
      retries: 10
      delay: 2
      tags: [docker]
    
    # ========================================================================
    # Docker User Permissions
    # ========================================================================
    
    - name: "Docker-Perms | Create docker group"
      group:
        name: docker
        state: present
      tags: [docker, docker-permissions]
    
    - name: "Docker-Perms | Add vagrant user to docker group"
      user:
        name: vagrant
        groups: docker
        append: yes
      tags: [docker, docker-permissions]
    
    - name: "Docker-Perms | Add root to docker group (for ansible)"
      user:
        name: root
        groups: docker
        append: yes
      tags: [docker, docker-permissions]
    
    - name: "Docker-Perms | Apply new group to current session"
      command: "usermod -aG docker vagrant"
      tags: [docker, docker-permissions]
    
    # ========================================================================
    # Verification & Testing
    # ========================================================================
    
    - name: "Verify | Docker version"
      shell: "docker --version"
      changed_when: false
      register: docker_ver
      tags: [docker, verify]
    
    - name: "Verify | Docker Compose version"
      shell: "docker compose version"
      changed_when: false
      register: compose_ver
      tags: [docker, verify]
    
    - name: "Verify | Test Docker daemon"
      shell: "docker run --rm hello-world"
      register: docker_test
      tags: [docker, verify]
      ignore_errors: yes
    
    - name: "Verify | Display versions and test result"
      debug:
        msg: |
          ====================================
          âœ… Docker Installation Complete
          ====================================
          {{ docker_ver.stdout }}
          {{ compose_ver.stdout }}
          
          Test result: 
          {{ docker_test.stdout_lines[-1] if docker_test.stdout_lines else 'Test skipped' }}
          ====================================
      tags: [docker, verify]
    
    - name: "Verify | Display Docker info"
      shell: "docker info | head -20"
      changed_when: false
      register: docker_info
      tags: [docker, verify]
    
    - name: "Verify | Show Docker info"
      debug:
        msg: "{{ docker_info.stdout_lines }}"
      tags: [docker, verify]
  
  # ============================================================================
  # Handlers
  # ============================================================================
  
  handlers:
    - name: Restart Docker
      service:
        name: docker
        state: restarted
      tags: [docker, docker-config]
