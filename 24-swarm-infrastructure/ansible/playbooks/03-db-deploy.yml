---
################################################################################
# Playbook: 03-db-deploy.yml
#
# Purpose: Déployer PostgreSQL en tant que container Docker
#   - Container PostgreSQL
#   - Volumes persistants
#   - Healthcheck
#   - Configuration initiale
#   - User et database par défaut
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/03-db-deploy.yml
#
# Tags:
#   - database
#   - postgres
#   - db-deploy
#   - db-verify
#
################################################################################

- name: "Deploy PostgreSQL Database"
  hosts: db_servers
  gather_facts: yes
  
  vars:
    postgres_container_name: "postgres"
    postgres_volume_name: "postgres-data"
  
  tasks:
    
    - name: "Display PostgreSQL deployment plan"
      debug:
        msg: |
          ====================================
          PostgreSQL Deployment
          ====================================
          Host: {{ ansible_hostname }}
          Version: {{ postgres_version }}
          Port: {{ postgres_port }}
          Database: {{ postgres_database }}
          User: {{ postgres_user }}
          ====================================
      tags: [always]
    
    # ========================================================================
    # Volumes Setup
    # ========================================================================
    
    - name: "DB | Create volume for PostgreSQL"
      shell: "docker volume create {{ postgres_volume_name }}"
      register: volume_create
      changed_when: "'created' in volume_create.stdout or volume_create.rc == 0"
      tags: [database, db-deploy]
      ignore_errors: yes
    
    # ========================================================================
    # Container Deployment
    # ========================================================================
    
    - name: "DB | Pull PostgreSQL image"
      shell: "docker pull postgres:{{ postgres_version }}-alpine"
      tags: [database, db-deploy]
    
    - name: "DB | Run PostgreSQL container"
      shell: |
        docker run -d \
          --name {{ postgres_container_name }} \
          --restart unless-stopped \
          -e POSTGRES_USER={{ postgres_user }} \
          -e POSTGRES_PASSWORD={{ postgres_password }} \
          -e POSTGRES_DB={{ postgres_database }} \
          -e POSTGRES_INITDB_ARGS="-c wal_level=replica" \
          -p {{ postgres_port }}:5432 \
          -v {{ postgres_volume_name }}:/var/lib/postgresql/data \
          -v /etc/localtime:/etc/localtime:ro \
          --health-cmd="pg_isready -U {{ postgres_user }}" \
          --health-interval=10s \
          --health-timeout=5s \
          --health-retries=5 \
          postgres:{{ postgres_version }}-alpine
      register: container_run
      changed_when: "'is already in use' not in container_run.stderr"
      tags: [database, db-deploy]
      ignore_errors: yes
    
    # ========================================================================
    # Verification
    # ========================================================================
    
    - name: "DB | Wait for PostgreSQL to be ready"
      shell: "docker exec {{ postgres_container_name }} pg_isready -U {{ postgres_user }}"
      register: pg_ready
      until: pg_ready is succeeded
      retries: 10
      delay: 2
      tags: [database, db-verify]
    
    - name: "DB | Display PostgreSQL status"
      shell: "docker inspect {{ postgres_container_name }} --format='{{.State.Status}}'"
      register: pg_status
      changed_when: false
      tags: [database, db-verify]
    
    - name: "DB | Show status"
      debug:
        msg: "PostgreSQL Status: {{ pg_status.stdout }}"
      tags: [database, db-verify]
    
    - name: "DB | Check database connection"
      shell: |
        docker exec {{ postgres_container_name }} \
          psql -U {{ postgres_user }} \
          -d {{ postgres_database }} \
          -c "SELECT version();"
      register: pg_version
      changed_when: false
      tags: [database, db-verify]
    
    - name: "DB | Display database info"
      debug:
        msg: "{{ pg_version.stdout_lines }}"
      tags: [database, db-verify]
    
    - name: "DB | Summary"
      debug:
        msg: |
          ====================================
          ✅ PostgreSQL Deployed
          ====================================
          Container: {{ postgres_container_name }}
          Image: postgres:{{ postgres_version }}-alpine
          Port: {{ postgres_port }}
          Status: {{ pg_status.stdout }}
          
          Connection:
          psql -h 192.168.56.23 \\
               -U {{ postgres_user }} \\
               -d {{ postgres_database }}
          ====================================
      tags: [always]
