---
################################################################################
# Playbook: 02-swarm-init.yml
#
# Purpose: Initialiser le cluster Docker Swarm
#   - Initialiser Swarm sur le manager
#   - Générer tokens worker
#   - Faire joindre les workers au cluster
#   - Vérifier l'état du cluster
#   - Configurer les labels de nœuds
#   - Tester la résilience
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/02-swarm-init.yml
#
# Tags:
#   - swarm
#   - swarm-init
#   - swarm-manager
#   - swarm-worker
#   - swarm-verify
#
################################################################################

- name: "Initialize Docker Swarm Cluster"
  hosts: all
  gather_facts: yes
  
  # ============================================================================
  # Role-specific blocks
  # ============================================================================
  
  tasks:
    
    - name: "Display Swarm initialization plan"
      debug:
        msg: |
          ====================================
          Docker Swarm Initialization
          ====================================
          Manager: {{ groups['swarm_managers'][0] }}
          Workers: {{ groups['swarm_workers'] | join(', ') }}
          Total nodes: {{ groups['swarm_nodes'] | length }}
          ====================================
      run_once: yes
      tags: [always]
    
    # ========================================================================
    # Initialize Swarm on Manager
    # ========================================================================
    
    - name: "Manager | Initialize Docker Swarm"
      docker_swarm:
        state: present
        advertise_addr: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
        default_addr_pool:
          - base: "10.0.0.0/8"
            size: 16
        force: no
      register: swarm_init
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
    
    - name: "Manager | Display Swarm initialization result"
      debug:
        msg: "{{ swarm_init }}"
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
    
    # ========================================================================
    # Generate Worker Tokens
    # ========================================================================
    
    - name: "Manager | Get worker join token"
      shell: "docker swarm join-token worker -q"
      register: worker_token
      changed_when: false
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
    
    - name: "Manager | Get manager join token"
      shell: "docker swarm join-token manager -q"
      register: manager_token
      changed_when: false
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
    
    - name: "Manager | Set token facts"
      set_fact:
        swarm_worker_token: "{{ worker_token.stdout }}"
        swarm_manager_token: "{{ manager_token.stdout }}"
        swarm_manager_address: "{{ hostvars[groups['swarm_managers'][0]]['ansible_host'] }}"
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init]
    
    # ========================================================================
    # Propagate Tokens to Workers
    # ========================================================================
    
    - name: "Worker | Set token facts from manager"
      set_fact:
        swarm_worker_token: "{{ hostvars[groups['swarm_managers'][0]]['swarm_worker_token'] }}"
        swarm_manager_address: "{{ hostvars[groups['swarm_managers'][0]]['swarm_manager_address'] }}"
      when: inventory_hostname in groups['swarm_workers']
      tags: [swarm, swarm-init]
    
    # ========================================================================
    # Join Workers to Swarm
    # ========================================================================
    
    - name: "Worker | Join Swarm cluster"
      shell: |
        docker swarm join \
          --token {{ swarm_worker_token }} \
          {{ swarm_manager_address }}:2377
      register: worker_join
      changed_when: "'This node joined a swarm' in worker_join.stdout"
      when: 
        - inventory_hostname in groups['swarm_workers']
        - swarm_worker_token is defined
      tags: [swarm, swarm-init, swarm-worker]
      ignore_errors: yes
    
    - name: "Worker | Display join result"
      debug:
        msg: "{{ worker_join.stdout }}"
      when: 
        - inventory_hostname in groups['swarm_workers']
        - worker_join.stdout is defined
      tags: [swarm, swarm-init, swarm-worker]
    
    # ========================================================================
    # Wait for cluster to stabilize
    # ========================================================================
    
    - name: "Manager | Wait for cluster to stabilize"
      shell: "docker node ls"
      register: node_list
      until: (node_list.stdout | regex_search('.*Ready.*')) is not none
      retries: 10
      delay: 2
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
    
    # ========================================================================
    # Configure Node Labels
    # ========================================================================
    
    - name: "Manager | Set worker labels"
      shell: |
        docker node update \
          --label-add workload=general \
          --label-add tier=worker \
          {{ inventory_hostname }}
      when: inventory_hostname in groups['swarm_workers']
      tags: [swarm, swarm-init, swarm-worker]
      run_once: yes
      delegate_to: "{{ groups['swarm_managers'][0] }}"
    
    - name: "Manager | Set manager labels"
      shell: |
        docker node update \
          --label-add role=manager \
          --label-add tier=control \
          {{ inventory_hostname }}
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-init, swarm-manager]
      run_once: yes
      delegate_to: "{{ groups['swarm_managers'][0] }}"
    
    # ========================================================================
    # Verification & Testing
    # ========================================================================
    
    - name: "Verify | List all nodes"
      shell: "docker node ls"
      changed_when: false
      register: nodes
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-verify]
    
    - name: "Verify | Display node list"
      debug:
        msg: |
          ====================================
          Docker Swarm Nodes
          ====================================
          {{ nodes.stdout }}
          ====================================
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-verify]
    
    - name: "Verify | Get swarm status"
      shell: "docker swarm ca --rotate"
      changed_when: false
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-verify]
      ignore_errors: yes
    
    - name: "Verify | Test overlay network"
      shell: |
        docker network create --driver overlay test-network && \
        docker network ls | grep -q test-network && \
        docker network rm test-network
      changed_when: false
      when: inventory_hostname in groups['swarm_managers']
      tags: [swarm, swarm-verify]
      ignore_errors: yes
    
    - name: "Verify | Display Swarm info"
      shell: "docker info | grep -A 10 Swarm"
      changed_when: false
      register: swarm_info
      tags: [swarm, swarm-verify]
    
    - name: "Verify | Show Swarm info"
      debug:
        msg: "{{ swarm_info.stdout_lines }}"
      tags: [swarm, swarm-verify]
    
    # ========================================================================
    # Summary
    # ========================================================================
    
    - name: "Summary | Swarm initialization completed"
      debug:
        msg: |
          ====================================
          ✅ Swarm Cluster Initialized
          ====================================
          Manager: {{ groups['swarm_managers'][0] }}
          Workers: {{ groups['swarm_workers'] | length }}
          Total nodes: {{ groups['swarm_nodes'] | length }}
          
          Manager IP: {{ swarm_manager_address }}
          Join token (worker): {{ swarm_worker_token[:20] }}...
          
          Next: Deploy services with:
          docker service create --mode global \
            --name myservice myimage
          ====================================
      run_once: yes
      tags: [always]
