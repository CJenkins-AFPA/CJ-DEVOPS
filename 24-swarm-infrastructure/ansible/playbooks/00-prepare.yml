---
################################################################################
# Playbook: 00-prepare.yml
# 
# Purpose: Préparer le système pour Docker et Swarm
#   - Updates et upgrades système
#   - Kernel tuning
#   - NTP synchronisation
#   - DNS configuration
#   - Firewall (optional)
#   - Swap tuning
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/00-prepare.yml
#
# Tags:
#   - system
#   - kernel
#   - network
#   - ntp
#   - firewall
#
################################################################################

- name: "Prepare System for Docker & Swarm"
  hosts: all
  gather_facts: yes
  
  vars:
    system_packages:
      - curl
      - wget
      - git
      - vim
      - nano
      - net-tools
      - dnsutils
      - telnet
      - software-properties-common
      - build-essential
      - python3
      - python3-pip
      - python3-apt
      - apt-transport-https
      - ca-certificates
      - openssh-client
      - openssh-server
      - gnupg
      - lsb-release
      - chrony
  
  tasks:
    - name: "System | Display system information"
      debug:
        msg: |
          ====================================
          System Information
          ====================================
          Hostname: {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
          Memory: {{ ansible_memtotal_mb }} MB
          CPUs: {{ ansible_processor_vcpus }}
          ====================================
      tags: [always]
    
    # ========================================================================
    # System Updates
    # ========================================================================
    
    - name: "System | Update apt cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [system]
    
    - name: "System | Upgrade all packages"
      apt:
        upgrade: dist
        autoclean: yes
        autoremove: yes
      tags: [system]
      register: apt_upgrade
      until: apt_upgrade is succeeded
      retries: 3
    
    - name: "System | Install essential packages"
      apt:
        name: "{{ system_packages }}"
        state: present
      tags: [system]
      register: apt_install
      until: apt_install is succeeded
      retries: 3
    
    # ========================================================================
    # Kernel Tuning
    # ========================================================================
    
    - name: "Kernel | Set sysctl parameters for Docker/Swarm"
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        # Network tuning for Docker
        - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
        - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
        - { name: "net.ipv4.ip_forward", value: "1" }
        - { name: "net.ipv4.conf.all.forwarding", value: "1" }
        - { name: "net.ipv4.conf.default.forwarding", value: "1" }
        
        # Connection tracking for load balancing
        - { name: "net.netfilter.nf_conntrack_max", value: "2097152" }
        - { name: "net.netfilter.nf_conntrack_tcp_timeout_established", value: "300" }
        
        # TCP tuning
        - { name: "net.ipv4.tcp_tw_reuse", value: "1" }
        - { name: "net.ipv4.tcp_tw_recycle", value: "0" }
        - { name: "net.ipv4.tcp_fin_timeout", value: "30" }
        - { name: "net.ipv4.tcp_keepalive_time", value: "600" }
        - { name: "net.ipv4.tcp_keepalive_intvl", value: "60" }
        - { name: "net.ipv4.tcp_keepalive_probes", value: "3" }
        
        # Socket tuning
        - { name: "net.core.somaxconn", value: "32768" }
        - { name: "net.ipv4.tcp_max_syn_backlog", value: "32768" }
      tags: [kernel]
    
    - name: "Kernel | Load br_netfilter module"
      modprobe:
        name: br_netfilter
        state: present
      tags: [kernel]
    
    - name: "Kernel | Load overlay module for Docker"
      modprobe:
        name: overlay
        state: present
      tags: [kernel]
    
    # Swap tuning
    - name: "Kernel | Set swappiness"
      sysctl:
        name: "vm.swappiness"
        value: "10"
        sysctl_set: yes
        state: present
        reload: yes
      tags: [kernel]
    
    # ========================================================================
    # NTP Configuration
    # ========================================================================
    
    - name: "NTP | Enable and start chrony"
      service:
        name: chrony
        state: started
        enabled: yes
      tags: [ntp]
    
    - name: "NTP | Check time synchronization"
      shell: "chronyc tracking | grep 'System time'"
      changed_when: false
      tags: [ntp]
      register: chrony_status
    
    - name: "NTP | Display time sync status"
      debug:
        msg: "{{ chrony_status.stdout }}"
      tags: [ntp]
    
    # ========================================================================
    # Hostname & DNS
    # ========================================================================
    
    - name: "Network | Set hostname"
      hostname:
        name: "{{ ansible_hostname }}"
        use: systemd
      tags: [network]
    
    - name: "Network | Add hostname to /etc/hosts"
      lineinfile:
        path: /etc/hosts
        line: "127.0.1.1 {{ ansible_hostname }} {{ ansible_hostname }}.local"
        state: present
      tags: [network]
    
    - name: "Network | Add Docker bridge to /etc/hosts"
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item]['ansible_host'] }} {{ item }} {{ item }}.local"
        state: present
      loop: "{{ groups['all'] }}"
      tags: [network]
    
    - name: "Network | Display network configuration"
      debug:
        msg: |
          ====================================
          Network Configuration
          ====================================
          Hostname: {{ ansible_hostname }}
          IPv4 Addresses: {{ ansible_all_ipv4_addresses }}
          ====================================
      tags: [network]
    
    # ========================================================================
    # Security: SSH Configuration
    # ========================================================================
    
    - name: "Security | Configure SSH for password auth"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PasswordAuthentication"
        line: "PasswordAuthentication yes"
        state: present
      notify: Restart SSH
      tags: [security]
    
    - name: "Security | Configure SSH for root login"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?PermitRootLogin"
        line: "PermitRootLogin yes"
        state: present
      notify: Restart SSH
      tags: [security]
    
    # ========================================================================
    # Firewall (UFW) - Optional, disabled by default
    # ========================================================================
    
    - name: "Firewall | Status"
      shell: "ufw status"
      changed_when: false
      tags: [firewall]
      register: firewall_status
    
    - name: "Firewall | Display status"
      debug:
        msg: "{{ firewall_status.stdout_lines }}"
      tags: [firewall]
    
    # ========================================================================
    # Summary
    # ========================================================================
    
    - name: "Summary | System preparation completed"
      debug:
        msg: |
          ====================================
          ✅ System Preparation Complete
          ====================================
          - System updated and upgraded
          - Kernel tuned for Docker/Swarm
          - NTP synchronized
          - Network configured
          - SSH configured
          ====================================
      tags: [always]
  
  # ============================================================================
  # Handlers
  # ============================================================================
  
  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted
