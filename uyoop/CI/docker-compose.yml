version: '3.8'

services:
  # GitLab CE supprimé (Passage en mode Hybride : GitLab.com + Runner Local)

  # GitLab Runner - Exécuteur de pipelines
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: ci-gitlab-runner
    restart: unless-stopped
    volumes:
      - ./gitlab/runner-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock  # Pour exécuter Docker dans Docker
    networks:
      - ci-network

  # Harbor - Registry Docker avec scan de sécurité
  # Note: Harbor nécessite docker-compose dédié (trop complexe pour un seul fichier)
  # Utiliser le docker-compose officiel de Harbor dans ./harbor/
  
  # Nginx pour l'app de démo (pendant développement)
  nginx-app:
    image: nginx:alpine
    container_name: ci-app-nginx
    restart: unless-stopped
    ports:
      - "8090:80"
    volumes:
      - ./app/public:/var/www/html/public:ro
      - ./app/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php-app
    networks:
      - ci-network

  # PHP-FPM pour l'app de démo
  php-app:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: ci-app-php
    restart: unless-stopped
    volumes:
      - ./app:/var/www/html
      - ./app/data:/var/www/html/data
    networks:
      - ci-network

networks:
  ci-network:
    driver: bridge

volumes:
  gitlab-runner-config:
