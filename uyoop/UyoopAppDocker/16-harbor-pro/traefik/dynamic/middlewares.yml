http:
  routers:
    # Harbor API Router
    harbor:
      rule: "Host(`{{ .Env.HARBOR_DOMAIN }}`)"
      entrypoints:
        - web
        - websecure
      service: harbor
      middlewares:
        - redirect-http
        - headers-default
      tls:
        certResolver: letsencrypt

    # Prometheus Router
    prometheus:
      rule: "Host(`{{ .Env.TRAEFIK_DASHBOARD_HOST }}`) && PathPrefix(`/prometheus`)"
      entrypoints:
        - websecure
      service: prometheus
      middlewares:
        - auth
        - strip-prometheus
        - headers-default
      tls:
        certResolver: letsencrypt

    # Grafana Router
    grafana:
      rule: "Host(`{{ .Env.TRAEFIK_DASHBOARD_HOST }}`) && PathPrefix(`/grafana`)"
      entrypoints:
        - websecure
      service: grafana
      middlewares:
        - auth
        - strip-grafana
        - headers-default
      tls:
        certResolver: letsencrypt

    # AlertManager Router
    alertmanager:
      rule: "Host(`{{ .Env.TRAEFIK_DASHBOARD_HOST }}`) && PathPrefix(`/alertmanager`)"
      entrypoints:
        - websecure
      service: alertmanager
      middlewares:
        - auth
        - strip-alertmanager
        - headers-default
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`{{ .Env.TRAEFIK_DASHBOARD_HOST }}`)"
      entrypoints:
        - websecure
      service: api@internal
      middlewares:
        - auth
        - headers-default
      tls:
        certResolver: letsencrypt

  services:
    harbor:
      loadBalancer:
        servers:
          - url: "http://harbor-core:8080"
        sticky:
          cookie:
            name: HARBOR_SESSION
            httpOnly: true
            secure: true
            sameSite: "Lax"
        healthCheck:
          scheme: http
          path: /api/v2.0/health
          interval: 30s
          timeout: 10s

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    alertmanager:
      loadBalancer:
        servers:
          - url: "http://alertmanager:9093"

  middlewares:
    # Redirect HTTP to HTTPS
    redirect-http:
      redirectScheme:
        scheme: https
        permanent: true

    # Authentication middleware
    auth:
      basicAuth:
        users:
          - "admin:$apr1$btzs.qc2$z5NcHDrYu6eP1Jk8HpYgm/"  # admin:password (hash with htpasswd)

    # Security headers
    headers-default:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        accessControlExposeHeaders:
          - X-Custom-Response-Header
        accessControlAllowHeaders:
          - X-Custom-Request-Header
        accessControlAllowCredentials: true
        addVaryHeader: true
        frameDeny: true
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
        customRequestHeaders:
          X-Forwarded-Host: "{{ .Request.Host }}"
          X-Real-IP: "{{ .RemoteAddr }}"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "geolocation=(), microphone=(), camera=()"

    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: "1m"

    # IP whitelist
    whitelist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"

    # Strip path prefix
    strip-prometheus:
      stripPrefix:
        prefixes:
          - "/prometheus"
        forceSlash: true

    strip-grafana:
      stripPrefix:
        prefixes:
          - "/grafana"
        forceSlash: true

    strip-alertmanager:
      stripPrefix:
        prefixes:
          - "/alertmanager"
        forceSlash: true

    # Compression
    gzip:
      compress:
        minResponseBodyBytes: 1000
        excludedContentTypes:
          - image/jpeg
          - image/png

    # Retry
    retry-policy:
      retry:
        attempts: 3
        initialInterval: "100ms"
        maxInterval: "10s"
