# Action History

- 2026-01-08: Docker Hardened Images (DHI) finalis√©. Build multi-stage avec roues binaires cp314 uniquement; runtime distroless nonroot; healthcheck interne Python; base OS 0 CVE; 3 CVE Python restantes √† corriger (ecdsa, python-jose, starlette).
- 2026-01-08: Int√©gration Compose compl√®te. Service app sur image durcie, healthcheck HTTP; suppression env_file; variables `VAULT_ADDR` (https) et `VAULT_CACERT`; Postgres healthy via healthcheck.
- 2026-01-08: Cluster Vault HA TLS op√©rationnel. 3 n≈ìuds Raft avec certificats; healthchecks `curl --cacert`; init container idempotent (init, unseal, join, AppRole, KV). `.env.vault` g√©n√©r√© dans volume partag√©; secrets hors compose.
- 2026-01-08: D√©ploiement 1‚Äëcommande valid√©. `docker compose up -d` depuis √©tat vierge construit tout, initialise Vault, et rend l‚Äôapp healthy (`/health`). Idempotence v√©rifi√©e (re-run sans erreur).


- 2026-01-07 23:45: **Externalisation Scripts/Styles + CSP Hardening + Suppression X-User-Id**. Cr√©√© app/static/style.css (616 lignes) et app/static/app.js (1233 lignes). Supprim√© fallback X-User-Id de get_current_user_secure ‚Üí JWT uniquement. CSP durci: supprim√© 'unsafe-inline' et 'unsafe-eval', autoris√© cdn.jsdelivr.net pour FullCalendar/Chart.js. Tests: JWT ‚úÖ, Events API ‚úÖ, Interface web ‚úÖ.
- 2026-01-07 23:10: **JWT Backend Authentication Fixed**. Root cause: HTTPBearer ‚Üí OAuth2PasswordBearer, JWT sub claim integer ‚Üí string, get_current_user_optional refactored. Tests: login ‚úÖ, POST/GET /events with Bearer token ‚úÖ, RBAC (DEV blocked from meeting) ‚úÖ, token refresh ‚úÖ. JWT Backend + Frontend now 100% operational.
- 2025-12: Initial context: FastAPI + FullCalendar app with PostgreSQL requirement; objective to align UI/features with provided mockup.
- 2025-12: Docker fixes: volume mount corrected to ./:/app (previously ./app:/app/app), Dockerfile COPY . . to match WORKDIR; containers healthy on ports 8000 (app) and 5433 (db).
- 2025-12: Frontend polish: Chart.js dashboards added; FullCalendar toolbar and today highlighting improved; header logo replaced with static/uG512.png (50x50).
- 2025-12: Event form UX: added start/end time inputs and duration handling; built a 3-step wizard with progress dots; type-specific fields persisted in JSONB extra.
- 2025-12: Bugfix: event deletion 404 resolved via ID validation and clearer error logging; action buttons expose IDs via title tooltips for debugging.
- 2025-12: RBAC overhaul: roles PROJET, DEV, OPS, ADMIN. Updated schemas/models/main.py and frontend role selectors. Rules: ADMIN full; PROJET all events; DEV only git_action; OPS only deployment_window; creator or ADMIN may edit/delete; git_action endpoint allowed for ADMIN/DEV.
- 2025-12: Git action endpoint: relaxed permission to ADMIN/DEV; validated subprocess execution path inside container.
- 2025-12: UI role mapping: French labels (Chef de projet, D√©veloppeur, Ops/SysAdmin, Administrateur) wired to literals PROJET/DEV/OPS/ADMIN.
- 2025-12: Calendar type filtering: new-event button filters allowed event types per active role before showing modal.
- 2025-12: JSONB schema: meeting (subtype/link/notes), deployment_window (environment/services/needs_approval), git_action (repo_url/branch/action/auto_trigger).
- 2026-01-07: Phase 1 validation kickoff: docker compose ps confirmed app up; db healthy; API reachable at http://127.0.0.1:8000.
- 2026-01-07: Created test users via /login: admin_test (ADMIN), dev_test (DEV), ops_test (OPS), projet_test (PROJET) with returned IDs 2-5.
- 2026-01-07: RBAC tests via API: DEV rejected for meeting (expected), allowed git_action; OPS rejected for meeting, allowed deployment_window; PROJET allowed meeting and deployment_window. Event IDs recorded: git_action id 7, deployment_window id 8, meeting id 9, deployment_window id 10.
- 2026-01-07: Documentation foundation: created and populated action-history.md and instructions-ia.md to preserve context across sessions.
- 2026-01-07: Next focus identified: frontend verification of role-based filtering and multi-step form with real users.
- 2026-01-07: Kit de contexte valid√©: action-history.md (journal) et instructions-ia.md (r√®gles) serviront de base pour les prochaines sessions.
- 2026-01-07: T√¢che √† venir: v√©rifier c√¥t√© frontend que le filtrage par r√¥le et le wizard √† 3 √©tapes respectent les r√®gles RBAC (avec users de test) et que les extra JSONB sont bien transmis.
- 2026-01-07: Session reprise: lecture compl√®te des fichiers action-history.md et instructions-ia.md pour assimiler le contexte projet.
- 2026-01-07: Correction donn√©es legacy: user "demo" (id=1) avait r√¥le "admin" (minuscules) causant erreur validation Pydantic; corrig√© en "ADMIN".
- 2026-01-07: Script test automatis√©: cr√©√© test_rbac.py (Python) pour valider permissions cr√©ation/suppression selon r√¥les; tous tests PASS (13/13).
- 2026-01-07: Validation RBAC backend compl√®te: DEV bloqu√© meeting/deployment (403); OPS bloqu√© meeting/git_action (403); PROJET autoris√© tous types; ADMIN autoris√© tout; permissions √©dition/suppression (cr√©ateur ou ADMIN) valid√©es.
- 2026-01-07: Persistance JSONB valid√©e: champs extra (subtype/link/notes pour meeting, environment/services/needs_approval pour deployment, repo_url/branch/action pour git_action) correctement stock√©s et r√©cup√©r√©s.
- 2026-01-07: Frontend wizard 3 √©tapes: structure pr√©sente dans index.html avec indicateurs de progression (dots), √©tape 1 (infos base), √©tape 2 (champs sp√©cifiques type), √©tape 3 (r√©capitulatif); champs extra construits c√¥t√© client avant envoi POST /events.
- 2026-01-07: Filtrage types √©v√©nements par r√¥le: logique pr√©sente dans newEventBtn (ligne ~1140 index.html); ADMIN/PROJET voient 3 options, DEV uniquement git_action, OPS uniquement deployment_window; typeSelect masqu√© si une seule option.
- 2026-01-07: Interface web ouverte sur http://127.0.0.1:8000 pour tests manuels; backend et frontend align√©s avec r√®gles RBAC; projet op√©rationnel et valid√©.
- 2026-01-07: Nettoyage documentation: suppression fichiers ETAT_PROJET.md, TESTS_MANUELS.md, test_rbac.sh cr√©√©s sans validation; conservation test_rbac.py (utile pour tests RBAC); consolidation infos dans action-history.md et instructions-ia.md uniquement.
- 2026-01-07: Processus IA formalis√© dans instructions-ia.md section 11: r√®gle proposition-validation obligatoire, interdiction de cr√©er fichiers non demand√©s, centralisation documentation dans 3 fichiers (action-history.md, instructions-ia.md, README.md).
- 2026-01-07: Tests RBAC Phase 2: 10 tests suppl√©mentaires ajout√©s (√©dition crois√©e, gestion users, endpoint git actions, cas limites X-User-Id); total 23/23 PASS; RBAC valid√© 100% fonctionnel.
- 2026-01-07: Restructuration dossiers: projet d√©plac√© dans /home/cj/gitdata/Python/uyoop-cal/ pour respecter organisation git (Python = branche, uyoop-cal = projet); chemins relatifs pr√©serv√©s, aucune modification code n√©cessaire; red√©marrage conteneurs OK.
- 2026-01-07: Roadmap d√©taill√©e int√©gr√©e dans instructions-ia.md section 15: phases 2-7 avec priorit√©s (auth mot de passe, m√©triques DORA, int√©grations CI/CD, gestion Agile, UX avanc√©e).
- 2026-01-07: Phase s√©curit√© 3 (Vault AppRole & database secrets):
  - ‚úÖ AppRole auth impl√©ment√© (remplace dev-root-token); policy minimale (app-policy)
  - ‚úÖ DATABASE_URL stock√©e dans Vault KV v2 (secret/app/config, cl√© database_url)
  - ‚úÖ R√©solution dynamique au d√©marrage: env var > Vault > fallback hardcoded
  - ‚úÖ vault_client.py: AppRole login avec fallback token; TOTP + KV full; logging diagnostic
  - ‚úÖ database.py: resolve_database_url() fonction avec fallbacks s√ªrs
  - ‚úÖ scripts/init-vault.sh: idempotent, configure engines/policy/approle/SECRET_ID, g√©n√®re .env.vault
  - ‚úÖ docker-compose.yml: suppression VAULT_TOKEN et DATABASE_URL en clair; env_file: .env.vault
  - ‚úÖ VAULT_APPROLE_SETUP.md: documentation compl√®te (architecture, setup, troubleshooting)
  - ‚úÖ Tests e2e: AppRole auth, DB URL resolution, TOTP workflow, login sans 2FA (requires_totp), login avec 2FA code (success), wrong code (401)
  - ‚úÖ S√©curit√©: aucun secret plaintext docker-compose, policies least-privilege, ready production vault+mTLS
  - Status: Pr√™t pour durcissement et d√©ploiement production.
- 2026-01-07: Phase s√©curit√© globale (5 √©tapes):
  - **√âtape 1 (‚úÖ TERMIN√â)**: Rate Limiting impl√©ment√© avec slowapi
    - Limiter /login et /2fa/* √† 5 req/min par IP
    - Ajout√© slowapi dans requirements.txt
    - Int√©gr√© dans main.py avec @limiter.limit("5 per 1 minute")
    - Test√©: 429 apr√®s d√©passement; r√©initialisation apr√®s 60s; login nominal OK
  - **√âtape 2 (üîÑ EN COURS)**: JWT Sessions (remplacer X-User-Id)
    - Backend ‚úÖ impl√©ment√©: auth.py avec create_access_token/create_refresh_token/verify_token
    - Sch√©mas ‚úÖ: LoginResponse avec access_token/refresh_token/token_type; TokenResponse; RefreshTokenRequest
    - Endpoint /login ‚úÖ: √©met tokens JWT apr√®s validation 2FA (requires_totp garde si d√©sactiv√©)
    - Endpoint /token/refresh ‚úÖ: renouvelle access_token avec refresh_token valide
    - D√©pendance get_current_user_secure ‚úÖ: pr√©f√®re JWT (Authorization: Bearer), fallback X-User-Id pour migration
    - Endpoints migr√©s ‚úÖ: /users, /events, /git_action utilisent get_current_user_secure
    - Requirements ‚úÖ: python-jose[cryptography], PyJWT ajout√©s
    - Frontend ‚è≥ EN ATTENTE: stocker tokens sessionStorage, passer Authorization header, impl√©menter refresh
  - **√âtape 3 (‚úÖ TERMIN√â)**: Security Headers (HSTS, CSP, etc.)
    - Middleware headers ajout√© dans main.py
    - Headers: Strict-Transport-Security max-age=31536000, Content-Security-Policy default-src 'self' unsafe-inline unsafe-eval, X-Frame-Options DENY, X-Content-Type-Options nosniff, Referrer-Policy strict-origin-when-cross-origin, Permissions-Policy geolocation=() microphone=() camera=()
    - Test√©: curl -I http://localhost:8000 confirme pr√©sence tous headers
    - CSP ‚ö†Ô∏è n√©cessite durcissement apr√®s migration frontend (remove unsafe-inline/unsafe-eval)
  - **√âtape 4 (‚úÖ TERMIN√â)**: Docker Hardening (multi-stage, non-root)
    - Dockerfile multi-stage: stage wheelhouse build wheels; stage runtime install depuis wheels
    - Runtime: USER appuser (non-root); WORKDIR /app
    - Build corrig√©: pip install -r /wheels/requirements.txt --find-links=/wheels --no-index
    - Image rebuild et app recr√©√©; logs: serveur d√©marre OK; ps montre UID appuser
    - ‚è≥ Prochains pas: read-only filesystem, drop capabilities, health checks
  - **√âtape 5 (‚è≥ √Ä VENIR)**: Vault Production (TLS, rotation)
    - Vault dev mode actuel (in-memory); production n√©cessite HA cluster + persistence
    - AppRole SECRET_ID statique (.env.vault); rotation hebdomadaire recommand√©e
    - TLS/mTLS pour Vault en prod; auto-renouvellement tokens AppRole; audit logging
    - R√©f√©rence: VAULT_APPROLE_SETUP.md section "Next Steps"
  - Status: Backend s√©curis√© (rate limiting, JWT backend ready, headers, Docker hardened); frontend migration JWT en attente.
- 2026-01-07: Workspace cleanup & documentation consolidation:
  - ‚úÖ Suppression app/repos/git/ (352MB, 4717 fichiers non n√©cessaires; tentative √©chou√©e ‚Üí permissions read-only)
  - ‚úÖ Suppression .venv/ (virtualenv non utilis√©; Docker env utilis√©)
  - ‚úÖ Suppression app/__pycache__/ (cache Python auto-r√©g√©n√©r√©)
  - ‚úÖ Cr√©ation doc/ folder (centralis√© documentation)
  - ‚úÖ D√©placement 5 fichiers: action-history.md, instructions-ia.md, IMPLEMENTATION_SUMMARY.md, SECURITE_GLOBALE.md, VAULT_APPROLE_SETUP.md ‚Üí doc/
  - ‚úÖ D√©placement test_rbac.py ‚Üí doc/ (test RBAC utile; conserv√©)
  - ‚úÖ README.md rest√© √† racine (demand√© par user)
- 2026-01-07: Consolidation documentation s√©curit√©:
  - ‚úÖ Fusion VAULT_APPROLE_SETUP.md ‚Üí SECURITE_GLOBALE.md (annexe "Vault AppRole & Secret Management")
  - ‚úÖ Ajout section "JWT Frontend Migration Details" (TokenManager, apiFetch, login/logout, tests valid√©s)
  - ‚úÖ Suppression VAULT_APPROLE_SETUP.md (contenu int√©gr√©)
  - ‚úÖ Statut √©tapes 1-5 mis √† jour dans tableau r√©capitulatif
  - ‚úÖ Documentation finalis√©e: 4 fichiers centralis√©s (action-history, instructions-ia, IMPLEMENTATION_SUMMARY, SECURITE_GLOBALE)
